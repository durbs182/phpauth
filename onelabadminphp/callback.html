<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <style>
        li
        {
            list-style-type: none;
        }
    </style>
</head>
<body>
   
    <script src="Scripts/jquery-2.0.2.js"></script>
    <script>
        var baseUrl = 'callback.php';
        

        $(function () {
            function log(msg) {
                $("<li>").html(msg).appendTo("ul")
            }

            var params = {},
                queryString = location.hash.substring(1),
                regex = /([^&=]+)=([^&]*)/g,
                m;
            while (m = regex.exec(queryString)) {
                params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
            }

			console.log(params);
			
            if (params.error) {
                log("error: " + params.error);
				window.location.href = "callback.php";
                return;
            }
			
            var state = sessionStorage["state"];
			
            if (params.state !== state) {
                log("error: bad state");
				window.location.href = "callback.php";
                return;
            }
			
			var stateUrl = baseUrl + "?state=1" + params.state;
			
			console.log(stateUrl);

            var token = params.access_token;
            console.log("Token Obtained: " + token);
            var response = '';
            var settings = {
                type: "GET",
                url: stateUrl,
                async: false,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Authorization", "Bearer " + token);
                },
                success: function (text, textStatus, xhr) {
                    console.log(xhr.status);
                    response = text;
                },
				complete: function(xhr, textStatus) {
					console.log(xhr.status);
				} 
            };

            $.ajax(settings);
            
            console.log(response);

            //window.location.href = response;
        });

    </script>
</body>
</html>
